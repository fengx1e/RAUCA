{% extends "base.html" %}

{% block title %}消融实验 - RAUCA{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="header-section">
    <h1>消融实验</h1>
    <p>定量评估不同损失函数对攻击成功率与检测置信度的影响。</p>
</div>

<div class="grid grid-cols-3">
    <div class="card" style="height: 850px; max-height: 850px; display: flex; flex-direction: column;">
        <h2 style="font-size: 1.5rem; margin-bottom: 24px;">实验设置</h2>
        <form id="ablationForm" style="flex: 1;">
            
            <div class="grid grid-cols-3" style="gap: 16px;">
                <div class="form-group" style="grid-column: span 2;">
                    <label>数据集路径</label>
                    <input type="text" name="datapath" value="data/dataset" required>
                </div>
                <div class="form-group">
                    <label>设备 (GPU ID)</label>
                    <input type="text" name="device" value="0" placeholder="0">
                </div>
            </div>

            <div class="grid grid-cols-2" style="gap: 16px; margin-bottom: 24px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Epochs (快速验证)</label>
                    <input type="number" name="epochs" value="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>数据比例 (%)</label>
                    <input type="number" name="data_fraction" value="1">
                </div>
            </div>

            <div class="form-group">
                <label>配置项选择:</label>

                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" name="configs" value="full" checked style="width: auto;">
                        <div>
                            <div style="font-weight: 600; color: #fff;">完整方法</div>
                            <div style="font-size: 0.75rem; color: #4ade80;">w_det=1.0, t=0.0001</div>
                        </div>
                    </div>
                    <div id="progress-full" style="display: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative;">
                        <div style="width: 0%; height: 100%; background: var(--accent-primary); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="text-full" style="display: none; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">0%</div>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" name="configs" value="no_det" style="width: auto;">
                        <div>
                            <div style="font-weight: 600; color: #fff;">无检测损失</div>
                            <div style="font-size: 0.75rem; color: #f87171;">w_det=0.0, t=0.0001</div>
                        </div>
                    </div>
                    <div id="progress-no_det" style="display: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative;">
                        <div style="width: 0%; height: 100%; background: var(--accent-primary); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="text-no_det" style="display: none; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">0%</div>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--card-border); display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" name="configs" value="no_smooth" style="width: auto;">
                        <div>
                            <div style="font-weight: 600; color: #fff;">无平滑损失</div>
                            <div style="font-size: 0.75rem; color: #f87171;">w_det=1.0, t=0.0</div>
                        </div>
                    </div>
                    <div id="progress-no_smooth" style="display: none; width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative;">
                        <div style="width: 0%; height: 100%; background: var(--accent-primary); transition: width 0.3s ease;"></div>
                    </div>
                    <div id="text-no_smooth" style="display: none; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">0%</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button type="button" onclick="runAblation()" class="btn btn-primary" style="flex: 1;">
                    开始实验
                </button>
                <button type="button" onclick="showResults()" class="btn btn-secondary" style="flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color:white;">
                    展示结果
                </button>
            </div>
        </form>

        <div id="statusBox" style="margin-top: 24px; display: none;">
            <div style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border: 1px solid var(--card-border);">
                <div class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span id="statusText" style="font-family: monospace; font-size: 0.875rem; color: var(--text-secondary);">初始化中...</span>
            </div>
        </div>
    </div>

    <div style="grid-column: span 2; display: flex; flex-direction: column; gap: 32px;">
        <div class="card">
            <h2 style="font-size: 1.5rem; margin-bottom: 24px;">定量分析结果 (ASR & 置信度)</h2>
            <div style="height: 380px; width: 100%;">
                <canvas id="metricsChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2 style="font-size: 1.5rem; margin-bottom: 24px;">具体数值对比</h2>
            <div id="visualGallery" class="grid grid-cols-1" style="gap: 16px; min-height: 180px;">
                <p style="text-align: center; color: var(--text-secondary); padding: 32px;">请运行实验或点击“展示结果”查看数据。</p>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 24px;">
    <h2 style="font-size: 1.5rem; margin-bottom: 16px;">可视化对比大屏</h2>
    <div id="comparisonGallery" style="display: grid; gap: 12px;">
        <p style="text-align: center; color: var(--text-secondary); padding: 24px;">暂无对比图片，请运行实验。</p>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // Configuration Map
    const configMap = {
        "full": "完整方法 (Full Method)",
        "no_det": "无检测损失 (No Det Loss)",
        "no_smooth": "无平滑损失 (No Smooth Loss)"
    };

    // 全局变量存储数据
    let globalResults = [];
    let globalComparisons = [];

    // === 修复关键：增加一个状态锁，防止重复刷新 ===
    let hasAutoLoadedResults = false;

    document.addEventListener('DOMContentLoaded', () => {
        // 绑定 Checkbox 点击事件，实现动态筛选显示
        document.querySelectorAll('input[name="configs"]').forEach(cb => {
            cb.addEventListener('change', () => {
                if (globalResults.length > 0 || globalComparisons.length > 0) {
                    renderAll();
                }
            });
        });

        setInterval(updateStatus, 1000);
        updateStatus();

        // 页面刚加载时，主动获取一次上次的结果
        showResults();
    });

    async function updateStatus() {
        try {
            const res = await fetch('/ablation_status');
            const state = await res.json();

            const statusBox = document.getElementById('statusBox');
            const statusText = document.getElementById('statusText');
            const startBtn = document.querySelector('button[onclick="runAblation()"]');

            if (state.status === 'running') {
                // === 状态：运行中 ===

                // 1. 重置自动加载锁，为下一次完成做准备
                hasAutoLoadedResults = false;

                statusBox.style.display = 'block';
                if (state.log && state.log.length > 0) {
                    statusText.innerText = state.log[state.log.length - 1];
                }
                statusText.style.color = '#38bdf8'; // Blue

                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.innerText = "实验进行中...";
                }

                if (state.active_cid) {
                    updateProgressBar(state.active_cid, state.progress_pct, state.epoch_current, state.epoch_total);
                }

                if (state.results) {
                    state.results.forEach(r => markConfigComplete(r.name));
                }

            } else if (state.status === 'completed') {
                // === 状态：已完成 ===

                statusBox.style.display = 'block';
                statusText.innerText = "实验已完成";
                statusText.style.color = '#4ade80'; // Green

                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.innerText = "开始实验";
                }

                if (state.results) {
                    state.results.forEach(r => markConfigComplete(r.name));

                    // === 修复关键：只有当 flag 为 false 时才刷新 ===
                    if (!hasAutoLoadedResults) {
                        console.log("Experiment finished, auto-refreshing results...");
                        showResults();
                        hasAutoLoadedResults = true; // 上锁，下次循环不再刷新
                    }
                }
            } else if (state.status === 'error') {
                statusBox.style.display = 'block';
                statusText.innerText = "发生错误: " + (state.error || "未知错误");
                statusText.style.color = '#f87171'; // Red
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.innerText = "重试实验";
                }
                // 出错时也重置锁，允许下次运行
                hasAutoLoadedResults = false;
            }
        } catch (e) {
            console.error("Polling error", e);
        }
    }

    function updateProgressBar(cid, pct, current, total) {
        const pBar = document.getElementById(`progress-${cid}`);
        const tBox = document.getElementById(`text-${cid}`);
        if (pBar && tBox) {
            pBar.style.display = 'block';
            tBox.style.display = 'block';
            pBar.children[0].style.width = pct + '%';
            tBox.innerText = `Epoch ${current}/${total} - ${pct}%`;
        }
    }

    function markConfigComplete(configName) {
        let key = Object.keys(configMap).find(k => configMap[k] === configName);
        if (key) {
            const pBar = document.getElementById(`progress-${key}`);
            const tBox = document.getElementById(`text-${key}`);
            if (pBar) {
                pBar.style.display = 'block';
                tBox.style.display = 'block';
                pBar.children[0].style.width = '100%';
                pBar.children[0].style.backgroundColor = '#4ade80';
                tBox.innerText = "完成";
            }
        }
    }

    async function runAblation() {
        const form = document.getElementById('ablationForm');
        document.getElementById('statusBox').style.display = 'block';
        document.getElementById('statusText').innerText = "正在提交请求...";

        // 重置 UI 进度条
        ['full', 'no_det', 'no_smooth'].forEach(id => {
            const pb = document.getElementById(`progress-${id}`);
            const tb = document.getElementById(`text-${id}`);
            if(pb) { pb.style.display = 'none'; pb.children[0].style.width = '0%'; pb.children[0].style.backgroundColor = 'var(--accent-primary)';}
            if(tb) { tb.style.display = 'none'; tb.innerText = "0%"; }
        });

        // 重置锁
        hasAutoLoadedResults = false;

        const formData = new FormData(form);
        try {
            const response = await fetch('/run_ablation', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.status === 'started') {
                updateStatus();
            } else {
                alert("启动失败: " + data.message);
            }
        } catch (error) {
            document.getElementById('statusText').innerText = "请求失败";
        }
    }

    async function showResults() {
        try {
            const res = await fetch('/get_last_ablation_results');
            const data = await res.json();

            // 兼容性处理
            if (Array.isArray(data)) {
                globalResults = data;
            } else {
                if (data.results) globalResults = data.results;
                if (data.comparisons) globalComparisons = data.comparisons;
            }

            renderAll();
        } catch (e) {
            console.log("获取结果暂不可用或解析失败", e);
        }
    }

    function renderAll() {
        // 获取当前用户勾选的配置 ID
        const checkedBoxes = Array.from(document.querySelectorAll('input[name="configs"]:checked'));
        const activeCids = checkedBoxes.map(cb => cb.value);

        if (globalResults.length > 0) {
            renderMetrics(activeCids);
        }
        if (globalComparisons.length > 0) {
            renderComparisonGallery(activeCids);
        }
    }

    function renderMetrics(activeCids) {
        // 过滤数据
        const filtered = globalResults.filter(r => {
            const key = Object.keys(configMap).find(k => configMap[k] === r.name);
            return activeCids.includes(key);
        });

        // 1. Chart
        const ctx = document.getElementById('metricsChart').getContext('2d');
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        const labels = filtered.map(r => r.name);
        const asrData = filtered.map(r => r.metrics.asr * 100);
        const confData = filtered.map(r => r.metrics.avg_conf_camo * 100);

        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ASR (%)', data: asrData, backgroundColor: 'rgba(56, 189, 248, 0.6)', borderColor: '#38bdf8', borderWidth: 1 },
                    { label: '置信度 (%)', data: confData, backgroundColor: 'rgba(248, 113, 113, 0.6)', borderColor: '#f87171', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });

        // 2. Metrics Table
        const gallery = document.getElementById('visualGallery');
        const colCount = filtered.length + 1;
        gallery.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;

        let html = '<div style="font-weight: 700; color: #fff; padding: 8px;">指标</div>';
        filtered.forEach(r => html += `<div style="font-weight: 700; color: #fff; padding: 8px; text-align: center;">${r.name}</div>`);

        html += '<div style="color: var(--text-secondary); padding: 8px;">ASR</div>';
        filtered.forEach(r => html += `<div style="color: var(--accent-primary); font-family: monospace; font-size: 1.1em; text-align: center; padding: 8px;">${(r.metrics.asr * 100).toFixed(1)}%</div>`);

        html += '<div style="color: var(--text-secondary); padding: 8px;">平均置信度</div>';
        filtered.forEach(r => html += `<div style="color: #f87171; font-family: monospace; font-size: 1.1em; text-align: center; padding: 8px;">${(r.metrics.avg_conf_camo * 100).toFixed(1)}%</div>`);

        gallery.innerHTML = html;
    }

    function renderComparisonGallery(activeCids) {
        const container = document.getElementById('comparisonGallery');

        if (activeCids.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 24px;">请至少勾选一个配置项以查看对比。</p>';
            return;
        }

        // 计算网格列数: 1列原图 + N列选中的伪装配置
        const totalCols = 1 + activeCids.length;

        container.style.display = 'grid';
        container.style.gridTemplateColumns = `repeat(${totalCols}, 1fr)`;
        container.style.gap = '16px';

        let html = '';

        globalComparisons.forEach(item => {
            // A. 原图 (指向 orig 文件夹)
            const origUrl = `/compare_out/${item.orig}`;
            html += `
                <div style="position: relative;">
                    <img src="${origUrl}" style="width: 100%; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.8); padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #fff;">
                        原始: ${item.id}
                    </div>
                </div>
            `;

            // B. 伪装图
            activeCids.forEach(cid => {
                const variant = item.variants.find(v => v.cid === cid);
                if (variant) {
                    const camoUrl = `/compare_out/${variant.path}`;
                    // 简写标签，比如 Full Method -> Full
                    const label = configMap[cid] ? configMap[cid].split('(')[0] : cid;
                    html += `
                        <div style="position: relative;">
                            <img src="${camoUrl}" style="width: 100%; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                            <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(56, 189, 248, 0.9); padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #000; font-weight: 600;">
                                ${label}
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="height: 100%; min-height: 100px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 0.8rem;">
                            图片缺失
                        </div>
                    `;
                }
            });
        });

        container.innerHTML = html;
    }
</script>
{% endblock %}
